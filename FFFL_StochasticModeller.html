<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFFL Monte Carlo Stochastic Analysis</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        #loader-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8">

    <div id="loader-overlay" class="fixed inset-0 bg-white bg-opacity-75 backdrop-blur-sm z-50 flex items-center justify-center pointer-events-none opacity-0">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-gray-700">Running 1,000 simulations...</p>
            <p class="text-gray-500">This may take a few moments.</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
             <a href="index.html" class="absolute top-0 left-0 inline-flex items-center text-purple-600 hover:text-purple-800 transition-colors font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Home
            </a>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 tracking-tight pt-10 sm:pt-0">FFFL Monte Carlo Stochastic Modeller</h1>
            <p class="mt-2 text-lg text-gray-600">Understand the range of potential outcomes for your retirement income.</p>
             <p class="mt-4 max-w-3xl mx-auto text-sm text-gray-500">
                This tool runs 1,000 individual retirement simulations, each with a different sequence of random market returns. It then aggregates the results to show you the statistical range (percentiles) of your potential annual income throughout retirement.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg-col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit space-y-6">
                
                <div>
                    <button id="runAnalysisBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>
                        Run Simulations
                    </button>
                </div>

                <!-- Core Assumptions -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>Core Assumptions</h2>
                    <div class="flex items-center justify-center bg-gray-100 rounded-lg p-1 mb-4">
                        <button id="modeMaxBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow">Max Income</button>
                        <button id="modeTargetBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Target Income</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputTargetStartingIncome" style="display: none;"></div>
                        <div id="inputStartingPot"></div>
                        <div id="inputStartingAge"></div>
                        <div id="inputAnnuityAge"></div>
                        <div id="inputCpi"></div>
                        <div id="inputAnnuityRate"></div>
                    </div>
                </div>
                
                <!-- Recalibration Strategy -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>Annual Recalibration Strategy</h2>
                     <div class="flex items-center justify-center bg-gray-100 rounded-lg p-1">
                        <button id="strategyRecalculateBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow">Recalculate Income</button>
                        <button id="strategySmoothBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Smooth Increases</button>
                    </div>
                </div>

                <!-- Fund Returns -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M12 2a10 10 0 0 0-4.37 18.02c.24.8.87 1.43 1.69 1.83a2.99 2.99 0 0 0 3.36 0c.82-.4 1.45-1.03 1.69-1.83A10 10 0 0 0 12 2Z"></path><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path><path d="M12 14a2.5 2.5 0 0 0-2.5 2.5v.5a2.5 2.5 0 0 0 5 0v-.5A2.5 2.5 0 0 0 12 14Z"></path></svg>Underlying Fund Returns</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputGrowthFundReturn"></div>
                        <div id="inputGrowthFundVolatility"></div>
                        <div id="inputLowRiskFundReturn"></div>
                        <div id="inputLowRiskFundVolatility"></div>
                     </div>
                </div>

                <!-- Investment Strategies -->
                <div class="border-t border-gray-200 pt-6 space-y-4">
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>Pot Investment Strategies (% Growth Fund)</h2>
                    <div id="strategyDrawdown"></div>
                    <div id="strategyAnnuity"></div>
                    <div id="strategyExcess"></div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2 space-y-8">
                 <div id="keyResultsCard" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200"></div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-semibold mb-4 text-gray-800">Simulated Income Percentiles</h3>
                    <div class="h-[400px]"><canvas id="incomePercentileChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Income Percentiles by Age</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead id="percentileThead"></thead>
                            <tbody id="percentileTbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-semibold mb-4 text-gray-800">Volatility in the year-to-year change in income (real)</h3>
                    <div class="h-[400px]"><canvas id="incomeVolatilityChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Volatility of Income Change by Age</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead id="incomeVolatilityThead"></thead>
                            <tbody id="incomeVolatilityTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Assumptions & Disclaimer Section -->
        <div class="mt-12 bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Key Assumptions & Disclaimer</h2>
            <div class="space-y-6 text-gray-600 text-sm">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Important Notes on This Modeller</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>This tool is for <strong class="font-semibold">illustrative purposes only</strong> and is not a guarantee of future performance. It runs 1,000 simulations to model a statistical range of possibilities, not to predict a definite outcome.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Core Assumptions</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong class="font-semibold">Market Returns:</strong> Investment returns are modelled using a 'log-normal' distribution, which is a standard assumption but may not capture all real-world market behaviours, such as 'fat tail' events (extreme, unexpected market crashes or booms).</li>
                        <li><strong class="font-semibold">Constant Assumptions:</strong> The inputs for average fund returns, volatility, inflation (CPI), and annuity rates are assumed to remain constant throughout the simulation. In reality, these economic factors will fluctuate over time.</li>
                        <li><strong class="font-semibold">Annuity Purchase:</strong> The model assumes an annuity is purchased at the specified 'Fix' age using the provided rate. The actual market rate available at that future date may be significantly different.</li>
                        <li><strong class="font-semibold">Glidepath:</strong> The de-risking 'glidepath' (the gradual shift from the start to end allocation) is linear. It assumes a smooth, even transition each year over the specified de-risking period.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-red-600 mb-2">Disclaimer</h3>
                    <p>
                        The results generated by this tool do not constitute financial advice. It is a simplified model intended to help users understand potential retirement income volatility under a specific set of assumptions. You should always consult with a qualified, independent financial adviser before making any investment or retirement decisions.
                    </p>
                </div>
            </div>
        </div>

    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE MANAGEMENT ---
    let state = {
        mode: 'max',
        targetStartingIncome: 40000,
        recalibrationStrategy: 'recalculate',
        startingPot: 1000000,
        startingAge: 65,
        annuityAge: 80,
        cpi: 3,
        annuityRate: 9.10,
        growthFundReturn: 5,
        growthFundVolatility: 10,
        lowRiskFundReturn: 3.5,
        lowRiskFundVolatility: 0,
        drawdownAllocationStart: 100,
        drawdownAllocationEnd: 100,
        annuityAllocationStart: 100,
        annuityAllocationEnd: 0,
        excessAllocation: 100,
        drawdownDeRiskingPeriod: 15,
        annuityDeRiskingPeriod: 15,
    };

    // --- DOM ELEMENT REFERENCES ---
    const dom = {
        runAnalysisBtn: document.getElementById('runAnalysisBtn'),
        modeMaxBtn: document.getElementById('modeMaxBtn'),
        modeTargetBtn: document.getElementById('modeTargetBtn'),
        inputTargetStartingIncome: document.getElementById('inputTargetStartingIncome'),
        strategyRecalculateBtn: document.getElementById('strategyRecalculateBtn'),
        strategySmoothBtn: document.getElementById('strategySmoothBtn'),
        keyResultsCard: document.getElementById('keyResultsCard'),
        percentileThead: document.getElementById('percentileThead'),
        percentileTbody: document.getElementById('percentileTbody'),
        incomeVolatilityThead: document.getElementById('incomeVolatilityThead'),
        incomeVolatilityTbody: document.getElementById('incomeVolatilityTbody'),
        loaderOverlay: document.getElementById('loader-overlay'),
    };

    // --- UI COMPONENT CREATORS ---
    
    function updateDeRiskingPeriods() {
        const maxDeRiskingPeriod = Math.max(1, state.annuityAge - state.startingAge);

        state.drawdownDeRiskingPeriod = Math.min(state.drawdownDeRiskingPeriod, maxDeRiskingPeriod);
        state.annuityDeRiskingPeriod = Math.min(state.annuityDeRiskingPeriod, maxDeRiskingPeriod);

        const drawdownSlider = document.getElementById('drawdownDeRiskingPeriodSlider');
        if (drawdownSlider) {
            drawdownSlider.max = maxDeRiskingPeriod;
            drawdownSlider.value = state.drawdownDeRiskingPeriod;
            drawdownSlider.nextElementSibling.textContent = `${state.drawdownDeRiskingPeriod} yrs`;
        }

        const annuitySlider = document.getElementById('annuityDeRiskingPeriodSlider');
        if (annuitySlider) {
            annuitySlider.max = maxDeRiskingPeriod;
            annuitySlider.value = state.annuityDeRiskingPeriod;
            annuitySlider.nextElementSibling.textContent = `${state.annuityDeRiskingPeriod} yrs`;
        }
    }

    const createInputField = ({ key, label, icon }) => {
        const container = document.getElementById(`input${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (!container) return;
        
        let unit = '%';
        let step = 0.1;
        const lowerCaseKey = key.toLowerCase();

        if (lowerCaseKey.includes('pot') || lowerCaseKey.includes('income')) {
            unit = 'Â£';
            step = 1000;
        } else if (lowerCaseKey.includes('age')) {
            unit = '';
            step = 1;
        }

        container.innerHTML = `
            <div class="relative">
                <label class="flex items-center text-sm font-medium text-gray-600 mb-1">${icon}<span class="ml-2">${label}</span></label>
                <div class="relative">
                    <input type="text" inputMode="${lowerCaseKey.includes('age') ? 'numeric' : 'decimal'}" step="${step}" value="${state[key]}" id="${key}Input" 
                           class="w-full pl-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 pr-10" />
                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 text-sm">${unit}</span>
                </div>
            </div>`;
        const inputEl = document.getElementById(`${key}Input`);
        inputEl.addEventListener('blur', () => {
            const parsedValue = parseFloat(inputEl.value);
            if (!isNaN(parsedValue)) {
                if (key === 'startingAge' && parsedValue >= state.annuityAge) {
                    inputEl.value = state.startingAge; 
                    return; 
                }
                if (key === 'annuityAge' && parsedValue <= state.startingAge) {
                    inputEl.value = state.annuityAge; 
                    return;
                }
                
                state[key] = parsedValue;
                
                if (key === 'startingAge' || key === 'annuityAge') {
                    updateDeRiskingPeriods();
                }
            } else {
                inputEl.value = state[key]; 
            }
        });
        inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { inputEl.blur(); } });
    };

    const createAllocationSlider = ({ potKey, label, startKey, endKey, deRiskKey }) => {
        const container = document.getElementById(`strategy${potKey}`);
        if (!container) return;
        const maxDeRisk = state.annuityAge - state.startingAge;
        const deRiskSliderHtml = deRiskKey ? `
            <div>
                <label class="text-sm font-medium text-gray-500">De-risking Period (Years)</label>
                <div class="flex items-center space-x-4">
                    <input type="range" min="1" max="${maxDeRisk}" value="${state[deRiskKey]}" id="${deRiskKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
                    <div class="font-semibold text-purple-600 w-12 text-right">${state[deRiskKey]} yrs</div>
                </div>
            </div>` : '';
        container.innerHTML = `
            <div class="p-4 border rounded-lg space-y-3 bg-gray-50">
                <label class="flex items-center text-md font-semibold text-gray-700">${label}</label>
                ${startKey ? `<div><label class="text-sm font-medium text-gray-500">Start Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[startKey]}" id="${startKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[startKey]}%</div></div></div>` : ''}
                ${endKey ? `<div><label class="text-sm font-medium text-gray-500">${startKey ? 'End' : ''} Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[endKey]}" id="${endKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[endKey]}%</div></div></div>` : ''}
                ${deRiskSliderHtml}
            </div>`;
        if (startKey) { document.getElementById(`${startKey}Slider`).addEventListener('input', (e) => { state[startKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[startKey]}%`; }); }
        if (endKey) { document.getElementById(`${endKey}Slider`).addEventListener('input', (e) => { state[endKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[endKey]}%`; }); }
        if (deRiskKey) { document.getElementById(`${deRiskKey}Slider`).addEventListener('input', (e) => { state[deRiskKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[deRiskKey]} yrs`; }); }
    };

    // --- CHART SETUP ---
    const incomeChartCtx = document.getElementById('incomePercentileChart').getContext('2d');
    const incomeVolatilityChartCtx = document.getElementById('incomeVolatilityChart').getContext('2d');
    let incomeChart, incomeVolatilityChart;

    function initializeCharts() {
        if (incomeChart) incomeChart.destroy();
        if (incomeVolatilityChart) incomeVolatilityChart.destroy();
        
        const commonTooltip = {
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) {
                        label += context.chart.options.scales.y.ticks.callback.call(this, context.parsed.y);
                    }
                    return label;
                }
            }
        };

        incomeChart = new Chart(incomeChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { 
            responsive: true, maintainAspectRatio: false, 
            scales: { x: { title: { display: true, text: 'Age' } }, y: { title: { display: true, text: 'Annual Income' }, ticks: { callback: (v) => formatCurrency(v) } } }, 
            plugins: { legend: { display: true, position: 'top' }, tooltip: commonTooltip } 
        }});

        incomeVolatilityChart = new Chart(incomeVolatilityChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { 
            responsive: true, maintainAspectRatio: false, 
            scales: { x: { title: { display: true, text: 'Age' } }, y: { title: { display: true, text: 'Std. Dev. of YoY Change' }, ticks: { callback: (v) => `${v.toFixed(1)}%` } } }, 
            plugins: { legend: { display: false }, tooltip: commonTooltip } 
        }});
    }

    // --- CALCULATION LOGIC ---
    const formatCurrency = (value) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
    const randomNormal = (mean, stdDev) => {
        let u1 = 0, u2 = 0;
        while (u1 === 0) u1 = Math.random();
        while (u2 === 0) u2 = Math.random();
        const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        return z0 * stdDev + mean;
    };
    const getBlendedRate = (alloc, p_growth, p_lowRisk) => (alloc / 100) * p_growth + (1 - alloc / 100) * p_lowRisk;
    const getInterpolatedAllocation = (startAlloc, endAlloc, currentYearIndex, totalFlexYears, deRiskingPeriod) => {
        const startOfGlidepathYear = totalFlexYears - deRiskingPeriod;
        if (currentYearIndex < startOfGlidepathYear) return startAlloc;
        if (deRiskingPeriod <= 1) return endAlloc;
        const glidepathYearIndex = currentYearIndex - startOfGlidepathYear;
        return startAlloc + (endAlloc - startAlloc) * (glidepathYearIndex / (deRiskingPeriod - 1));
    };

    const solveForMaxIncome = (p_startPot, p_startAge, p_endAge, p_params) => {
        if (p_startAge >= p_endAge) return p_startPot * (p_params.annuityRate / 100);
        let lowIncome = 0, highIncome = p_startPot;
        for (let i = 0; i < 100; i++) {
            const guessIncome = (lowIncome + highIncome) / 2;
            if (guessIncome <= 0) { highIncome = 0; continue; }
            const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(guessIncome, p_startAge, p_endAge, p_params);
            if (annuityPotRequired + drawdownPotRequired < p_startPot) lowIncome = guessIncome; else highIncome = guessIncome;
        }
        return lowIncome;
    };
    
    const solveForEffectiveCpi = (baseIncome, pot, startAge, endAge, params) => {
        let lowCpi = -50, highCpi = 50;
        for(let s=0; s<100; s++) {
            const guessCpi = (lowCpi + highCpi) / 2;
            const tempParams = {...params, cpi: guessCpi};
            const { annuityPotRequired: rAnnuity, drawdownPotRequired: rDrawdown } = calculateRequiredPots(baseIncome, startAge, endAge, tempParams);
            const requiredPot = (rAnnuity + rDrawdown) * (1 + guessCpi / 100);
            if (requiredPot < pot) lowCpi = guessCpi; else highCpi = guessCpi;
        }
        return lowCpi;
    };

    const calculateRequiredPots = (income, p_startAge, p_endAge, p_params) => {
        const { drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, growthFundReturn, lowRiskFundReturn, startingAge, annuityAge, cpi, annuityRate } = p_params;
        const yearsInFlex = p_endAge - p_startAge;
        if (yearsInFlex <= 0) return { annuityPotRequired: 0, drawdownPotRequired: 0 };
        let cumulativeAnnuityDiscount = 1;
        for (let i = 0; i < yearsInFlex; i++) {
            const absoluteYearIndex = (p_startAge - startingAge) + i;
            const allocation = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, absoluteYearIndex, annuityAge - startingAge, annuityDeRiskingPeriod);
            cumulativeAnnuityDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
        }
        const finalIncomeRequired = income * Math.pow(1 + cpi / 100, yearsInFlex);
        const targetAnnuityPotValue = finalIncomeRequired / (annuityRate / 100);
        const annuityPotRequired = targetAnnuityPotValue / cumulativeAnnuityDiscount;
        let drawdownPotRequired = 0;
        for (let j = 0; j < yearsInFlex; j++) {
            let cumulativeDrawdownDiscount = 1;
            for (let k = 0; k < j + 1; k++) {
                const absoluteYearIndex = (p_startAge - startingAge) + k;
                const allocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, absoluteYearIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
                cumulativeDrawdownDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
            }
            const incomeForYearJ = income * Math.pow(1 + cpi / 100, j);
            const endOfYearAbsoluteIndex = (p_startAge - startingAge) + j;
            const endOfYearAllocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, endOfYearAbsoluteIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
            drawdownPotRequired += incomeForYearJ / (cumulativeDrawdownDiscount / (1 + getBlendedRate(endOfYearAllocation, growthFundReturn, lowRiskFundReturn) / 100));
        }
        return { annuityPotRequired, drawdownPotRequired };
    };
    
    // --- CORE SIMULATION LOGIC ---
    function runMonteCarloSimulations() {
        dom.loaderOverlay.classList.remove('opacity-0', 'pointer-events-none');
        
        setTimeout(() => {
            const NUM_SIMULATIONS = 1000;
            const allIncomePaths = [];
            const params = { ...state };
            const { startingAge, annuityAge } = params;
            const yearsInFlex = annuityAge - startingAge;

            const initialIncome = params.mode === 'target' ? params.targetStartingIncome : solveForMaxIncome(params.startingPot, startingAge, annuityAge, params);
            const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(initialIncome, startingAge, annuityAge, params);
            const initialExcessPot = Math.max(0, params.startingPot - (annuityPotRequired + drawdownPotRequired));

            for (let s = 0; s < NUM_SIMULATIONS; s++) {
                const incomePath = [];
                let currentAnnuityPot = annuityPotRequired, currentDrawdownPot = drawdownPotRequired, currentExcessPot = initialExcessPot;
                let currentIncome = initialIncome;
                let isOffTrack = false;

                for (let i = 0; i < yearsInFlex; i++) {
                    incomePath.push(currentIncome);
                    const currentAge = startingAge + i;
                    
                    currentDrawdownPot -= currentIncome;

                    const randGrowthReturn = randomNormal(params.growthFundReturn, params.growthFundVolatility);
                    const randLowRiskReturn = randomNormal(params.lowRiskFundReturn, params.lowRiskFundVolatility);

                    const drawdownAlloc = getInterpolatedAllocation(params.drawdownAllocationStart, params.drawdownAllocationEnd, i, yearsInFlex, params.drawdownDeRiskingPeriod);
                    const annuityAlloc = getInterpolatedAllocation(params.annuityAllocationStart, params.annuityAllocationEnd, i, yearsInFlex, params.annuityDeRiskingPeriod);

                    currentDrawdownPot = Math.max(0, currentDrawdownPot * (1 + getBlendedRate(drawdownAlloc, randGrowthReturn, randLowRiskReturn) / 100));
                    currentAnnuityPot *= (1 + getBlendedRate(annuityAlloc, randGrowthReturn, randLowRiskReturn) / 100);
                    currentExcessPot *= (1 + getBlendedRate(params.excessAllocation, randGrowthReturn, randLowRiskReturn) / 100);
                    
                    const nextYearTotalPot = currentDrawdownPot + currentAnnuityPot + currentExcessPot;
                    
                    let nextYearIncome;
                    let effectiveCpi = params.cpi;

                    if (params.mode === 'target' && !isOffTrack) {
                        const nextTargetIncome = currentIncome * (1 + params.cpi / 100);
                        const { annuityPotRequired: reqA, drawdownPotRequired: reqD } = calculateRequiredPots(nextTargetIncome, currentAge + 1, annuityAge, params);
                        if (nextYearTotalPot >= (reqA + reqD)) {
                            nextYearIncome = nextTargetIncome;
                        } else {
                            isOffTrack = true;
                            if (params.recalibrationStrategy === 'smooth' && currentAge < annuityAge - 1) {
                                effectiveCpi = solveForEffectiveCpi(currentIncome, nextYearTotalPot, currentAge + 1, annuityAge, params);
                                nextYearIncome = currentIncome * (1 + effectiveCpi / 100);
                            } else {
                                nextYearIncome = solveForMaxIncome(nextYearTotalPot, currentAge + 1, annuityAge, params);
                            }
                        }
                    } else { 
                        if (params.recalibrationStrategy === 'smooth' && currentAge < annuityAge - 1) {
                            effectiveCpi = solveForEffectiveCpi(currentIncome, nextYearTotalPot, currentAge + 1, annuityAge, params);
                            nextYearIncome = currentIncome * (1 + effectiveCpi / 100);
                        } else {
                            nextYearIncome = solveForMaxIncome(nextYearTotalPot, currentAge + 1, annuityAge, params);
                        }
                    }

                    if (currentAge < annuityAge - 1) {
                        const tempParams = { ...params, cpi: effectiveCpi };
                        const { annuityPotRequired: nextAnnuity, drawdownPotRequired: nextDrawdown } = calculateRequiredPots(nextYearIncome, currentAge + 1, annuityAge, tempParams);
                        currentAnnuityPot = nextAnnuity;
                        currentDrawdownPot = nextDrawdown;
                        currentExcessPot = Math.max(0, nextYearTotalPot - (nextAnnuity + nextDrawdown));
                    }
                    currentIncome = nextYearIncome;
                }
                incomePath.push(currentIncome);
                allIncomePaths.push(incomePath);
            }

            processResults(allIncomePaths, params, initialIncome);
            dom.loaderOverlay.classList.add('opacity-0', 'pointer-events-none');
        }, 50);
    }

    const calculateStdDev = (arr) => {
        const n = arr.length;
        if (n === 0) return 0;
        const mean = arr.reduce((a, b) => a + b) / n;
        const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
        return Math.sqrt(variance);
    };

    function processResults(allIncomePaths, params, initialIncome) {
        const { startingAge, annuityAge, cpi } = params;
        const years = Array.from({length: annuityAge - startingAge + 1}, (_, i) => startingAge + i);
        const percentiles = [0.05, 0.25, 0.50, 0.75, 0.95];
        
        const incomePercentileData = {};
        const incomeVolatilityData = [];
        const allChangesFlat = [];

        const allIncomeChangePaths = allIncomePaths.map(path => {
            const changePath = [0]; 
            for (let i = 1; i < path.length; i++) {
                const netChange = ((path[i] / path[i-1]) / (1 + cpi / 100) - 1) * 100;
                changePath.push(netChange);
                allChangesFlat.push(netChange);
            }
            return changePath;
        });

        for (let i = 0; i < years.length; i++) {
            const incomesForYear = allIncomePaths.map(path => path[i]).sort((a, b) => a - b);
            const incomeChangesForYear = allIncomeChangePaths.map(path => path[i]);
            
            incomeVolatilityData.push(calculateStdDev(incomeChangesForYear));

            percentiles.forEach(p => {
                if (!incomePercentileData[p]) incomePercentileData[p] = [];
                const index = Math.floor(p * (incomesForYear.length - 1));
                incomePercentileData[p].push(incomesForYear[index]);
            });
        }
        
        const overallVolatility = calculateStdDev(allChangesFlat);
        const yearsInFlex = annuityAge - startingAge;
        const inflationFactor = Math.pow(1 + cpi / 100, yearsInFlex);

        const keyMetrics = {
            initialIncome: initialIncome,
            incomeAtFixAge_5th: incomePercentileData[0.05][years.length - 1],
            incomeAtFixAge_95th: incomePercentileData[0.95][years.length - 1],
            realIncomeAtFixAge_5th: incomePercentileData[0.05][years.length - 1] / inflationFactor,
            realIncomeAtFixAge_95th: incomePercentileData[0.95][years.length - 1] / inflationFactor,
            overallVolatility: overallVolatility,
        };
        
        updateUI(incomePercentileData, incomeVolatilityData, years, keyMetrics);
    }

    // --- UI UPDATE ---
    function updateUI(incomeData, volatilityData, years, keyMetrics) {
        const colors = { 0.05: '#ef4444', 0.25: '#f97316', 0.50: '#22c55e', 0.75: '#3b82f6', 0.95: '#8b5cf6' };
        const labels = { 0.05: '5th Percentile', 0.25: '25th Percentile', 0.50: 'Median', 0.75: '75th Percentile', 0.95: '95th Percentile' };

        dom.keyResultsCard.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Key Results</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Starting Income</h4>
                    <p class="text-2xl font-bold text-gray-800 mt-1">
                        ${formatCurrency(keyMetrics.initialIncome)}
                    </p>
                    <p class="text-xs text-gray-400">(Age ${state.startingAge})</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Nominal Income Range at Age ${state.annuityAge}</h4>
                    <p class="text-2xl font-bold text-gray-800 mt-1">
                        ${formatCurrency(keyMetrics.incomeAtFixAge_5th)} - ${formatCurrency(keyMetrics.incomeAtFixAge_95th)}
                    </p>
                    <p class="text-xs text-gray-400">(Value at Age ${state.annuityAge})</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Real Income Range (Today's Money)</h4>
                    <p class="text-2xl font-bold text-purple-600 mt-1">
                        ${formatCurrency(keyMetrics.realIncomeAtFixAge_5th)} - ${formatCurrency(keyMetrics.realIncomeAtFixAge_95th)}
                    </p>
                    <p class="text-xs text-gray-400">(Value at Age ${state.annuityAge}, in today's terms)</p>
                </div>
            </div>
            <div class="border-t border-gray-200 mt-6 pt-4 text-center">
                 <h4 class="text-sm font-medium text-gray-500">Overall Income Volatility (Real)</h4>
                 <p class="text-2xl font-bold text-gray-800 mt-1">${keyMetrics.overallVolatility.toFixed(2)}%</p>
                 <p class="text-xs text-gray-400">(Std. Dev. of YoY Change)</p>
            </div>
        `;

        incomeChart.data.labels = years;
        incomeChart.data.datasets = Object.keys(incomeData).map(p => ({
            label: labels[p], data: incomeData[p], borderColor: colors[p],
            backgroundColor: colors[p] + '33', fill: p == 0.05 ? false : '-1',
            tension: 0.1, borderWidth: 2, pointRadius: 0,
        }));
        incomeChart.update();

        incomeVolatilityChart.data.labels = years;
        incomeVolatilityChart.data.datasets = [{
            label: 'Std. Dev. of Income Change',
            data: volatilityData,
            borderColor: '#6366f1', 
            backgroundColor: '#6366f1' + '33',
            fill: 'origin',
            tension: 0.1,
            borderWidth: 2,
            pointRadius: 0,
        }];
        incomeVolatilityChart.update();

        updatePercentileTable(dom.percentileThead, dom.percentileTbody, years, incomeData, (v) => formatCurrency(v));
        updateVolatilityTable(dom.incomeVolatilityThead, dom.incomeVolatilityTbody, years, volatilityData, (v) => `${v.toFixed(1)}%`);
    }

    function updatePercentileTable(thead, tbody, years, data, formatter) {
        thead.innerHTML = `<tr class="border-b-2 border-gray-200">
            <th class="py-2 px-2 font-semibold">Age</th>
            <th class="py-2 px-2 font-semibold text-right">5th Pctl</th>
            <th class="py-2 px-2 font-semibold text-right">25th Pctl</th>
            <th class="py-2 px-2 font-semibold text-right">Median</th>
            <th class="py-2 px-2 font-semibold text-right">75th Pctl</th>
            <th class="py-2 px-2 font-semibold text-right">95th Pctl</th>
        </tr>`;

        let tableHtml = '';
        years.forEach((age, index) => {
            tableHtml += `<tr class="border-b border-gray-100">
                <td class="py-2 px-2 font-medium">${age}</td>
                <td class="py-2 px-2 text-right">${formatter(data[0.05][index])}</td>
                <td class="py-2 px-2 text-right">${formatter(data[0.25][index])}</td>
                <td class="py-2 px-2 text-right font-bold">${formatter(data[0.50][index])}</td>
                <td class="py-2 px-2 text-right">${formatter(data[0.75][index])}</td>
                <td class="py-2 px-2 text-right">${formatter(data[0.95][index])}</td>
            </tr>`;
        });
        tbody.innerHTML = tableHtml;
    }
    
    function updateVolatilityTable(thead, tbody, years, data, formatter) {
        thead.innerHTML = `<tr class="border-b-2 border-gray-200">
            <th class="py-2 px-2 font-semibold">Age</th>
            <th class="py-2 px-2 font-semibold text-right">Volatility (Std. Dev.)</th>
        </tr>`;

        let tableHtml = '';
        years.forEach((age, index) => {
            if (index === 0) return; 
            tableHtml += `<tr class="border-b border-gray-100">
                <td class="py-2 px-2 font-medium">${age}</td>
                <td class="py-2 px-2 text-right font-bold">${formatter(data[index])}</td>
            </tr>`;
        });
        tbody.innerHTML = tableHtml;
    }


    // --- INITIALIZATION ---
    function initializeApp() {
        createInputField({ key: 'startingPot', label: 'Starting Pension Pot', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>' });
        createInputField({ key: 'startingAge', label: 'Your Starting Age', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'annuityAge', label: "Annuity 'Fix' Age", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'cpi', label: 'Inflation (CPI)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'annuityRate', label: 'Annuity Rate - CPI linked (%)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        createInputField({ key: 'growthFundReturn', label: 'Avg. Growth Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'growthFundVolatility', label: 'Growth Volatility (Std. Dev.)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>' });
        createInputField({ key: 'lowRiskFundReturn', label: 'Avg. Low-Risk Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' });
        createInputField({ key: 'lowRiskFundVolatility', label: 'Low-Risk Volatility (Std. Dev.)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>' });
        createInputField({ key: 'targetStartingIncome', label: 'Target Starting Income', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        
        createAllocationSlider({ potKey: 'Drawdown', label: 'Pre-annuity Drawdown Pot', startKey: 'drawdownAllocationStart', endKey: 'drawdownAllocationEnd', deRiskKey: 'drawdownDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Annuity', label: 'Annuity Pot', startKey: 'annuityAllocationStart', endKey: 'annuityAllocationEnd', deRiskKey: 'annuityDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Excess', label: 'Excess Pot (Fixed)', endKey: 'excessAllocation' });
        
        dom.modeMaxBtn.addEventListener('click', () => {
            state.mode = 'max';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'none';
        });
        dom.modeTargetBtn.addEventListener('click', () => {
            state.mode = 'target';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'block';
        });

        dom.strategyRecalculateBtn.addEventListener('click', () => {
            state.recalibrationStrategy = 'recalculate';
            dom.strategyRecalculateBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.strategySmoothBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
        });
        dom.strategySmoothBtn.addEventListener('click', () => {
            state.recalibrationStrategy = 'smooth';
            dom.strategySmoothBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.strategyRecalculateBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
        });

        dom.runAnalysisBtn.addEventListener('click', runMonteCarloSimulations);
        
        initializeCharts();
        runMonteCarloSimulations();
    }

    initializeApp();
});
</script>
</body>
</html>
