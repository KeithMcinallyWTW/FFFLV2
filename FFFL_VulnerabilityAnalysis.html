<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFFL Vulnerability Analysis</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7c3aed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
            <a href="index.html" class="absolute top-0 left-0 inline-flex items-center text-purple-600 hover:text-purple-800 transition-colors font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Home
            </a>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 tracking-tight pt-10 sm:pt-0">FFFL Vulnerability Analysis</h1>
            <p class="mt-2 text-lg text-gray-600">Identify which years are most vulnerable to a market shock.</p>
             <p class="mt-4 max-w-3xl mx-auto text-sm text-gray-500">
                This tool runs a batch analysis based on the 'Flex First, Fix Later' methodology. It simulates a market shock for every year of your flexible retirement phase. The results show the impact on your sustainable income under two different adjustment strategies, helping you identify the age at which your plan is most sensitive to a downturn.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit space-y-6">
                
                <div>
                    <button id="runAnalysisBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        Run Analysis
                    </button>
                </div>

                <!-- Core Assumptions -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>Core Assumptions</h2>
                    <div class="flex items-center justify-center bg-gray-100 rounded-lg p-1 mb-4">
                        <button id="modeMaxBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow">Max Income</button>
                        <button id="modeTargetBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Target Income</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputTargetStartingIncome" style="display: none;"></div>
                        <div id="inputStartingPot"></div>
                        <div id="inputStartingAge"></div>
                        <div id="inputAnnuityAge"></div>
                        <div id="inputCpi"></div>
                        <div id="inputAnnuityRate"></div>
                    </div>
                </div>
                
                <!-- Fund Returns -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M12 2a10 10 0 0 0-4.37 18.02c.24.8.87 1.43 1.69 1.83a2.99 2.99 0 0 0 3.36 0c.82-.4 1.45-1.03 1.69-1.83A10 10 0 0 0 12 2Z"></path><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path><path d="M12 14a2.5 2.5 0 0 0-2.5 2.5v.5a2.5 2.5 0 0 0 5 0v-.5A2.5 2.5 0 0 0 12 14Z"></path></svg>Underlying Fund Returns</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputGrowthFundReturn"></div>
                        <div id="inputLowRiskFundReturn"></div>
                     </div>
                </div>

                <!-- Investment Strategies -->
                <div class="border-t border-gray-200 pt-6 space-y-4">
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>Pot Investment Strategies (% Growth Fund)</h2>
                    <div id="strategyDrawdown"></div>
                    <div id="strategyAnnuity"></div>
                    <div id="strategyExcess"></div>
                </div>
                
                <!-- Shock Parameters -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-red-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Shock Parameters</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputShockReturn"></div>
                        <div id="inputShockLowRiskReturn"></div>
                        <div id="inputShockAnnuityRate"></div>
                     </div>
                </div>

            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                 <div id="resultsContainer" class="space-y-8" style="display: none;">
                    <div id="summaryCard" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200"></div>
                    <div id="initialSplitCard" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200"></div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-semibold mb-4 text-gray-800">"Recalculate" Strategy: Income Reduction %</h3>
                        <div class="h-[250px]"><canvas id="recalculateImpactChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-semibold mb-4 text-gray-800">"Smooth" Strategy: Reduction in future increases in the flex period (%)</h3>
                        <div class="h-[250px]"><canvas id="smoothImpactChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Scenario Breakdown</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead id="breakdownThead"></thead>
                                <tbody id="breakdownTbody"></tbody>
                            </table>
                            <p id="tableFootnote" class="text-xs text-gray-500 mt-2" style="display: none;"></p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 mb-3">Important Disclaimers</h2>
                        <div class="space-y-3 text-sm text-gray-600">
                            <p>This tool is for illustrative and educational purposes only and does not constitute financial, investment, or retirement advice.</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>The projections are based on the assumptions you provide and do not reflect the performance of any specific investment.</li>
                                <li>Past performance is not a guarantee of future results. Investment returns can be volatile and may result in the loss of principal.</li>
                                <li>Annuity rates, inflation (CPI), and market conditions can change and may be different from the assumptions used in this model.</li>
                                <li>This model does not account for taxes, fees, or other charges that may apply to your pension or investments.</li>
                                <li>You should not rely on these results to make any financial decisions. It is essential to consult with a qualified and regulated financial advisor before making any decisions about your retirement or investments.</li>
                            </ul>
                        </div>
                    </div>
                 </div>
                 <div id="loaderContainer" class="w-full h-96 flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg border border-gray-200">
                     <div class="loader"></div>
                     <p class="mt-4 text-gray-600 font-semibold">Running scenarios...</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal for Detailed Analysis -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 sm:p-8 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modalContent" class="space-y-6"></div>
        </div>
    </div>
    
    <!-- Tooltip Element -->
    <div id="tooltip" class="absolute z-50 w-64 p-3 text-sm font-light text-white bg-gray-900 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE MANAGEMENT ---
    let state = {
        mode: 'max', // 'max' or 'target'
        targetStartingIncome: 40000,
        startingPot: 1000000,
        startingAge: 65,
        annuityAge: 80,
        cpi: 3,
        growthFundReturn: 5,
        lowRiskFundReturn: 3.5,
        drawdownAllocationStart: 100,
        drawdownAllocationEnd: 100,
        annuityAllocationStart: 100,
        annuityAllocationEnd: 0,
        excessAllocation: 100,
        annuityRate: 9.10,
        drawdownDeRiskingPeriod: 15,
        annuityDeRiskingPeriod: 15,
        shockReturn: -20,
        shockLowRiskReturn: 3.5,
        shockAnnuityRate: 9.10,
        analysisResults: [], // Store full results here
    };

    // --- DOM ELEMENT REFERENCES ---
    const dom = {
        modeMaxBtn: document.getElementById('modeMaxBtn'),
        modeTargetBtn: document.getElementById('modeTargetBtn'),
        inputTargetStartingIncome: document.getElementById('inputTargetStartingIncome'),
        runAnalysisBtn: document.getElementById('runAnalysisBtn'),
        resultsContainer: document.getElementById('resultsContainer'),
        loaderContainer: document.getElementById('loaderContainer'),
        summaryCard: document.getElementById('summaryCard'),
        initialSplitCard: document.getElementById('initialSplitCard'),
        breakdownThead: document.getElementById('breakdownThead'),
        breakdownTbody: document.getElementById('breakdownTbody'),
        tableFootnote: document.getElementById('tableFootnote'),
        detailsModal: document.getElementById('detailsModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalContent: document.getElementById('modalContent'),
        closeModalBtn: document.getElementById('closeModalBtn'),
        tooltip: document.getElementById('tooltip'),
    };

    // --- UI COMPONENT CREATORS ---
    const createInputField = ({ key, label, icon, isCurrency = false, disabled = false }) => {
        const container = document.getElementById(`input${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (!container) return;
        const unit = isCurrency ? '£' : (label.includes('Age') ? '' : '%');
        const step = isCurrency ? 1000 : (label.includes('Age') ? 1 : 0.1);
        container.innerHTML = `
            <div class="relative">
                <label class="flex items-center text-sm font-medium text-gray-600 mb-1">${icon}<span class="ml-2">${label}</span></label>
                <div class="relative">
                    <input type="text" inputMode="decimal" step="${step}" value="${state[key]}" id="${key}Input" 
                           class="w-full pl-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 ${unit ? 'pr-10' : 'pr-3'} ${disabled ? 'bg-gray-100 cursor-not-allowed' : ''}" 
                           ${disabled ? 'disabled' : ''} />
                    ${unit ? `<span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 text-sm">${unit}</span>` : ''}
                </div>
            </div>`;
        if (!disabled) {
            const inputEl = document.getElementById(`${key}Input`);
            inputEl.addEventListener('blur', () => {
                const parsedValue = parseFloat(inputEl.value);
                if (!isNaN(parsedValue)) { state[key] = parsedValue; } else { inputEl.value = state[key]; }
            });
            inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { inputEl.blur(); } });
        }
    };

    const createAllocationSlider = ({ potKey, label, startKey, endKey, deRiskKey }) => {
        const container = document.getElementById(`strategy${potKey}`);
        if (!container) return;
        const deRiskSliderHtml = deRiskKey ? `
            <div>
                <label class="text-sm font-medium text-gray-500">De-risking Period (Years)</label>
                <div class="flex items-center space-x-4">
                    <input type="range" min="1" max="${state.annuityAge - state.startingAge}" value="${state[deRiskKey]}" id="${deRiskKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
                    <div class="font-semibold text-purple-600 w-12 text-right">${state[deRiskKey]} yrs</div>
                </div>
            </div>` : '';
        container.innerHTML = `
            <div class="p-4 border rounded-lg space-y-3 bg-gray-50">
                <label class="flex items-center text-md font-semibold text-gray-700">${label}</label>
                ${startKey ? `<div><label class="text-sm font-medium text-gray-500">Start Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[startKey]}" id="${startKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[startKey]}%</div></div></div>` : ''}
                ${endKey ? `<div><label class="text-sm font-medium text-gray-500">${startKey ? 'End' : ''} Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[endKey]}" id="${endKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[endKey]}%</div></div></div>` : ''}
                ${deRiskSliderHtml}
            </div>`;
        if (startKey) { document.getElementById(`${startKey}Slider`).addEventListener('input', (e) => { state[startKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[startKey]}%`; }); }
        if (endKey) { document.getElementById(`${endKey}Slider`).addEventListener('input', (e) => { state[endKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[endKey]}%`; }); }
        if (deRiskKey) { document.getElementById(`${deRiskKey}Slider`).addEventListener('input', (e) => { state[deRiskKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[deRiskKey]} yrs`; }); }
    };

    // --- CHART SETUP ---
    const recalculateImpactChartCtx = document.getElementById('recalculateImpactChart').getContext('2d');
    const smoothImpactChartCtx = document.getElementById('smoothImpactChart').getContext('2d');
    let recalculateImpactChart, smoothImpactChart;

    function initializeCharts() {
        if (recalculateImpactChart) recalculateImpactChart.destroy();
        if (smoothImpactChart) smoothImpactChart.destroy();
        const onChartClick = (event) => {
            const points = event.chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (points.length) {
                const firstPoint = points[0];
                const index = firstPoint.index;
                showDetailedAnalysis(index);
            }
        };
        const commonOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Shock Age', color: '#4b5563' } } }, plugins: { legend: { display: false } }, onClick: onChartClick };
        recalculateImpactChart = new Chart(recalculateImpactChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { title: { display: true, text: 'Income Reduction', color: '#4b5563' }, ticks: { callback: (v) => `${v}%` } } }, plugins: { ...commonOptions.plugins, tooltip: { callbacks: { label: (c) => ` ${c.parsed.y.toFixed(2)}% income reduction` } } } } });
        smoothImpactChart = new Chart(smoothImpactChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { title: { display: true, text: 'Reduction (%)', color: '#4b5563' }, ticks: { callback: (v) => `${v}%` } } }, plugins: { ...commonOptions.plugins, tooltip: { callbacks: { label: (c) => ` ${c.parsed.y.toFixed(2)}% reduction in future increases` } } } } });
    }

    // --- CALCULATION LOGIC ---
    const formatCurrency = (value) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
    const getBlendedRate = (alloc, p_growth, p_lowRisk) => (alloc / 100) * p_growth + (1 - alloc / 100) * p_lowRisk;
    const getInterpolatedAllocation = (startAlloc, endAlloc, currentYearIndex, totalFlexYears, deRiskingPeriod) => {
        const startOfGlidepathYear = totalFlexYears - deRiskingPeriod;
        if (currentYearIndex < startOfGlidepathYear) return startAlloc;
        if (deRiskingPeriod <= 1) return endAlloc;
        const glidepathYearIndex = currentYearIndex - startOfGlidepathYear;
        return startAlloc + (endAlloc - startAlloc) * (glidepathYearIndex / (deRiskingPeriod - 1));
    };

    const solveForMaxIncome = (p_startPot, p_startAge, p_endAge, p_cpi, p_annuityRate, p_params) => {
        if (p_startAge >= p_endAge) return p_startPot * (p_annuityRate / 100);
        let lowIncome = 0, highIncome = p_startPot;
        for (let i = 0; i < 100; i++) {
            const guessIncome = (lowIncome + highIncome) / 2;
            if (guessIncome <= 0) { highIncome = 0; continue; }
            const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(guessIncome, p_startAge, p_endAge, p_cpi, p_annuityRate, p_params);
            if (annuityPotRequired + drawdownPotRequired < p_startPot) lowIncome = guessIncome; else highIncome = guessIncome;
        }
        return lowIncome;
    };

    const calculateRequiredPots = (income, p_startAge, p_endAge, p_cpi, p_annuityRate, p_params) => {
        const { drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, growthFundReturn, lowRiskFundReturn, startingAge, annuityAge } = p_params;
        const yearsInFlex = p_endAge - p_startAge;
        if (yearsInFlex <= 0) return { annuityPotRequired: 0, drawdownPotRequired: 0 };
        let cumulativeAnnuityDiscount = 1;
        for (let i = 0; i < yearsInFlex; i++) {
            const absoluteYearIndex = (p_startAge - startingAge) + i;
            const allocation = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, absoluteYearIndex, annuityAge - startingAge, annuityDeRiskingPeriod);
            cumulativeAnnuityDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
        }
        const finalIncomeRequired = income * Math.pow(1 + p_cpi / 100, yearsInFlex);
        const targetAnnuityPotValue = finalIncomeRequired / (p_annuityRate / 100);
        const annuityPotRequired = targetAnnuityPotValue / cumulativeAnnuityDiscount;
        let drawdownPotRequired = 0;
        for (let j = 0; j < yearsInFlex; j++) {
            let cumulativeDrawdownDiscount = 1;
            for (let k = 0; k < j + 1; k++) {
                const absoluteYearIndex = (p_startAge - startingAge) + k;
                const allocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, absoluteYearIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
                cumulativeDrawdownDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
            }
            const incomeForYearJ = income * Math.pow(1 + p_cpi / 100, j);
            const endOfYearAbsoluteIndex = (p_startAge - startingAge) + j;
            const endOfYearAllocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, endOfYearAbsoluteIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
            drawdownPotRequired += incomeForYearJ / (cumulativeDrawdownDiscount / (1 + getBlendedRate(endOfYearAllocation, growthFundReturn, lowRiskFundReturn) / 100));
        }
        return { annuityPotRequired, drawdownPotRequired };
    };
    
    // --- CORE SCENARIO LOGIC ---
    function calculateShockImpacts(p_shockAge) {
        const params = { ...state };
        const { mode, targetStartingIncome, startingPot, startingAge, annuityAge, cpi, annuityRate, shockReturn, shockLowRiskReturn, shockAnnuityRate, drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, excessAllocation, growthFundReturn, lowRiskFundReturn } = params;
        
        const initialIncome = mode === 'target' ? targetStartingIncome : solveForMaxIncome(startingPot, startingAge, annuityAge, cpi, annuityRate, params);
        
        const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(initialIncome, startingAge, annuityAge, cpi, annuityRate, params);
        const requiredTotal = annuityPotRequired + drawdownPotRequired;
        const initialExcessPot = Math.max(0, startingPot - requiredTotal);
        
        const initialSplit = { drawdown: drawdownPotRequired, annuity: annuityPotRequired, excess: initialExcessPot, requiredTotal: requiredTotal };

        if (mode === 'target' && (requiredTotal > startingPot)) {
            return { error: 'Unsustainable', initialSplit, initialIncome };
        }

        let currentAnnuityPot = annuityPotRequired, currentDrawdownPot = drawdownPotRequired, currentExcessPot = initialExcessPot;
        let currentIncome = initialIncome;
        const yearsInFlex = annuityAge - startingAge;

        for (let i = 0; i < yearsInFlex; i++) {
            const currentAge = startingAge + i;
            const drawdownAlloc = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, i, yearsInFlex, drawdownDeRiskingPeriod);
            const annuityAlloc = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, i, yearsInFlex, annuityDeRiskingPeriod);
            
            if (currentAge === p_shockAge) {
                const potsBeforeShock = { drawdown: currentDrawdownPot, annuity: currentAnnuityPot, excess: currentExcessPot };
                
                const blendedDrawdownGrowth = getBlendedRate(drawdownAlloc, shockReturn, shockLowRiskReturn);
                const blendedAnnuityGrowth = getBlendedRate(annuityAlloc, shockReturn, shockLowRiskReturn);
                const blendedExcessGrowth = getBlendedRate(excessAllocation, shockReturn, shockLowRiskReturn);
                const endOfYearDrawdownPot = (currentDrawdownPot - currentIncome) * (1 + blendedDrawdownGrowth / 100);
                const endOfYearAnnuityPot = currentAnnuityPot * (1 + blendedAnnuityGrowth / 100);
                const endOfYearExcessPot = currentExcessPot * (1 + blendedExcessGrowth / 100);
                
                const potsAfterShock = { drawdown: endOfYearDrawdownPot, annuity: endOfYearAnnuityPot, excess: endOfYearExcessPot };
                const postShockTotalPot = Math.max(0, endOfYearDrawdownPot) + endOfYearAnnuityPot + endOfYearExcessPot;
                const incomeThatWasDue = currentIncome * (1 + cpi / 100);
                
                let potsAfterRebalance, recalculateResult, smoothResult;

                if (mode === 'target') {
                    const { annuityPotRequired: requiredAnnuity, drawdownPotRequired: requiredDrawdown } = calculateRequiredPots(incomeThatWasDue, currentAge + 1, annuityAge, cpi, shockAnnuityRate, params);
                    const totalRequiredForTarget = requiredAnnuity + requiredDrawdown;
                    if (postShockTotalPot >= totalRequiredForTarget) {
                        potsAfterRebalance = { drawdown: requiredDrawdown, annuity: requiredAnnuity, excess: postShockTotalPot - totalRequiredForTarget };
                        recalculateResult = { incomeBeforeShock: incomeThatWasDue, incomeAfterShock: incomeThatWasDue };
                        smoothResult = { incomeBeforeShock: incomeThatWasDue, incomeAfterShock: incomeThatWasDue, newEffectiveCpi: cpi, isFinalYearFallback: false };
                        return { initialSplit, initialIncome, recalculateResult, smoothResult, potsBeforeShock, potsAfterShock, potsAfterRebalance };
                    }
                }

                const postShockIncome_recalc = solveForMaxIncome(postShockTotalPot, currentAge + 1, annuityAge, cpi, shockAnnuityRate, params);
                recalculateResult = { incomeBeforeShock: incomeThatWasDue, incomeAfterShock: postShockIncome_recalc };
                const { annuityPotRequired: recalcAnnuity, drawdownPotRequired: recalcDrawdown } = calculateRequiredPots(postShockIncome_recalc, currentAge + 1, annuityAge, cpi, shockAnnuityRate, params);
                potsAfterRebalance = { drawdown: recalcDrawdown, annuity: recalcAnnuity, excess: postShockTotalPot - (recalcAnnuity + recalcDrawdown) };

                let postShockIncome_smooth, effectiveCpi_smooth, isFinalYearFallback = false;
                if (currentAge === annuityAge - 1) {
                    const recalcReductionPercent = incomeThatWasDue > 0 ? (1 - postShockIncome_recalc / incomeThatWasDue) * 100 : 0;
                    postShockIncome_smooth = postShockIncome_recalc;
                    effectiveCpi_smooth = cpi - recalcReductionPercent; 
                    isFinalYearFallback = true;
                } else {
                    let lowCpi = -50, highCpi = 50;
                    for (let s = 0; s < 100; s++) {
                        const guessCpi = (lowCpi + highCpi) / 2;
                        const { annuityPotRequired: rAnnuity, drawdownPotRequired: rDrawdown } = calculateRequiredPots(incomeThatWasDue, currentAge + 1, annuityAge, guessCpi, shockAnnuityRate, params);
                        if (rAnnuity + rDrawdown < postShockTotalPot) lowCpi = guessCpi; else highCpi = guessCpi;
                    }
                    postShockIncome_smooth = incomeThatWasDue;
                    effectiveCpi_smooth = lowCpi;
                }
                smoothResult = { incomeBeforeShock: incomeThatWasDue, incomeAfterShock: postShockIncome_smooth, newEffectiveCpi: effectiveCpi_smooth, isFinalYearFallback };
                
                return { initialSplit, initialIncome, recalculateResult, smoothResult, potsBeforeShock, potsAfterShock, potsAfterRebalance };
            }
            
            const blendedDrawdownGrowth = getBlendedRate(drawdownAlloc, growthFundReturn, lowRiskFundReturn);
            const blendedAnnuityGrowth = getBlendedRate(annuityAlloc, growthFundReturn, lowRiskFundReturn);
            const blendedExcessGrowth = getBlendedRate(excessAllocation, growthFundReturn, lowRiskFundReturn);
            currentDrawdownPot = (currentDrawdownPot - currentIncome) * (1 + blendedDrawdownGrowth / 100);
            currentAnnuityPot *= (1 + blendedAnnuityGrowth / 100);
            currentExcessPot *= (1 + blendedExcessGrowth / 100);
            currentIncome *= (1 + cpi / 100);
        }
        return null;
    }

    // --- BATCH ANALYSIS & UI UPDATE ---
    async function runBatchAnalysis() {
        dom.loaderContainer.style.display = 'flex';
        dom.resultsContainer.style.display = 'none';
        await new Promise(resolve => setTimeout(resolve, 50));
        state.analysisResults = [];
        const { startingAge, annuityAge } = state;
        for (let shockAge = startingAge; shockAge < annuityAge; shockAge++) {
            const impactResults = calculateShockImpacts(shockAge); 
            if (impactResults) { state.analysisResults.push({ shockAge, ...impactResults }); }
        }
        updateUI(state.analysisResults);
        dom.loaderContainer.style.display = 'none';
        dom.resultsContainer.style.display = 'block';
    }

    function updateUI(results) {
        const firstResult = results.length > 0 ? results[0] : null;

        if (firstResult && firstResult.initialSplit) {
            const { drawdown, annuity, excess, requiredTotal } = firstResult.initialSplit;
            const initialIncome = firstResult.initialIncome;
            const incomeTitle = state.mode === 'target' ? 'Target Starting Income' : 'Max Starting Income';

            let content = `<h3 class="text-xl font-semibold text-gray-800">Initial Plan</h3>`;
            
            if (firstResult.error) {
                content += `<div class="bg-red-50 p-4 rounded-lg text-center mt-4"><p class="font-semibold text-red-700">Target Income is Unsustainable</p><p class="text-sm text-red-600 mt-1">Required Pot: ${formatCurrency(requiredTotal)}</p><p class="text-sm text-red-600">Your Pot: ${formatCurrency(state.startingPot)}</p></div>`;
            } else {
                content += `
                    <div class="mt-4 text-center">
                        <h4 class="text-sm font-medium text-gray-500">${incomeTitle}</h4>
                        <p class="text-3xl font-bold text-purple-600 mt-1">${formatCurrency(initialIncome)}</p>
                    </div>
                    <div class="border-t my-4"></div>
                    <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Initial Pot Allocation</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div><h4 class="text-sm font-medium text-gray-500">Drawdown Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(drawdown)}</p></div>
                        <div><h4 class="text-sm font-medium text-gray-500">Annuity Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(annuity)}</p></div>
                        <div><h4 class="text-sm font-medium text-gray-500">Excess Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(excess)}</p></div>
                    </div>`;
            }
            dom.initialSplitCard.innerHTML = content;
        }

        let mostVulnerableRecalculate = { shockAge: -1, reduction: 100 };
        results.filter(r => !r.error).forEach(r => { if (r.recalculateResult.incomeBeforeShock > 0) { const reduction = r.recalculateResult.incomeAfterShock / r.recalculateResult.incomeBeforeShock; if (reduction < mostVulnerableRecalculate.reduction) { mostVulnerableRecalculate = { shockAge: r.shockAge, reduction: reduction, percentageDrop: (1 - reduction) * 100 }; } } });
        let mostVulnerableSmooth = { shockAge: -1, newCpi: state.cpi };
        results.filter(r => !r.error).forEach(r => { if (r.smoothResult.newEffectiveCpi < mostVulnerableSmooth.newCpi && !r.smoothResult.isFinalYearFallback) { mostVulnerableSmooth = { shockAge: r.shockAge, newCpi: r.smoothResult.newEffectiveCpi, cpiDrop: state.cpi - r.smoothResult.newEffectiveCpi }; } });

        dom.summaryCard.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-gray-800">Analysis Summary</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
            <div class="bg-purple-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-700 flex items-center justify-center">"Recalculate" Strategy <svg class="ml-2 w-4 h-4 text-gray-400 tooltip-trigger" data-tooltip="Recalibrates your income such that inflation protection is still retained in the future." xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></h4>
                <p class="text-sm text-gray-600 mt-1">Most vulnerable age:</p><p class="text-3xl font-bold text-purple-600 mt-1">${mostVulnerableRecalculate.shockAge > -1 ? mostVulnerableRecalculate.shockAge : 'N/A'}</p><p class="text-md font-semibold text-red-600 mt-1">${mostVulnerableRecalculate.shockAge > -1 ? `Income falls by ${mostVulnerableRecalculate.percentageDrop.toFixed(1)}%` : 'Sustainable'}</p></div>
            <div class="bg-teal-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-700 flex items-center justify-center">"Smooth" Strategy <svg class="ml-2 w-4 h-4 text-gray-400 tooltip-trigger" data-tooltip="Aims to maintain the current income level but reduces future increases." xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></h4>
                <p class="text-sm text-gray-600 mt-1">Most vulnerable age:</p><p class="text-3xl font-bold text-teal-600 mt-1">${mostVulnerableSmooth.shockAge > -1 ? mostVulnerableSmooth.shockAge : 'N/A'}</p><p class="text-md font-semibold text-orange-600 mt-1">${mostVulnerableSmooth.shockAge > -1 ? `Future increases drop by ${mostVulnerableSmooth.cpiDrop.toFixed(2)}%` : 'Sustainable'}</p></div></div>`;

        const labels = results.map(r => r.shockAge);
        const validRecalcData = results.map(r => r.error ? 0 : (r.recalculateResult.incomeBeforeShock > 0 ? (1 - r.recalculateResult.incomeAfterShock / r.recalculateResult.incomeBeforeShock) * 100 : 0));
        recalculateImpactChart.data = { labels, datasets: [{ label: '% Income Reduction', data: validRecalcData, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.3, borderWidth: 2 }] };
        recalculateImpactChart.update();
        const validSmoothData = results.map(r => r.error ? 0 : (state.cpi - r.smoothResult.newEffectiveCpi));
        smoothImpactChart.data = { labels, datasets: [{ label: 'Reduction in future increases (%)', data: validSmoothData, borderColor: '#2dd4bf', backgroundColor: 'rgba(45, 212, 191, 0.1)', fill: true, tension: 0.3, borderWidth: 2 }] };
        smoothImpactChart.update();

        dom.breakdownThead.innerHTML = `<tr class="border-b-2 border-gray-200"><th rowspan="2" class="py-3 px-2 font-semibold text-gray-600 align-bottom">Shock Age</th><th colspan="3" class="py-3 px-2 font-semibold text-gray-600 text-center border-b border-l">Recalculate Strategy</th><th colspan="2" class="py-3 px-2 font-semibold text-gray-600 text-center border-b border-l">Smooth Strategy</th></tr><tr class="border-b-2 border-gray-200"><th class="py-2 px-2 font-medium text-gray-500 text-center border-l">Post-Shock Income</th><th class="py-2 px-2 font-medium text-gray-500 text-center">Reduction (£)</th><th class="py-2 px-2 font-medium text-gray-500 text-center">Reduction (%)</th><th class="py-2 px-2 font-medium text-gray-500 text-center border-l">New Increase Rate</th><th class="py-2 px-2 font-medium text-gray-500 text-center">Reduction (%)</th></tr>`;
        dom.breakdownTbody.innerHTML = results.map(row => {
            if (row.error) { return `<tr class="border-b border-gray-100"><td class="py-3 px-2 font-medium text-center">${row.shockAge}</td><td colspan="5" class="py-3 px-2 text-center text-red-600 font-bold bg-red-50">Target Income Unsustainable</td></tr>`; }
            const { shockAge, recalculateResult, smoothResult } = row;
            const recalcReductionAmount = recalculateResult.incomeBeforeShock - recalculateResult.incomeAfterShock;
            const recalcReductionPercent = recalculateResult.incomeBeforeShock > 0 ? (1 - recalculateResult.incomeAfterShock / recalculateResult.incomeBeforeShock) * 100 : 0;
            const smoothCpiDrop = state.cpi - smoothResult.newEffectiveCpi;
            return `<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="py-3 px-2 font-medium text-center">${shockAge}${smoothResult.isFinalYearFallback ? '*' : ''}</td><td class="py-3 px-2 text-center border-l">${formatCurrency(recalculateResult.incomeAfterShock)}</td><td class="py-3 px-2 text-center ${recalcReductionAmount > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(recalcReductionAmount)}</td><td class="py-3 px-2 text-center font-semibold ${recalcReductionPercent > 0.05 ? 'text-red-600' : 'text-green-600'}">${recalcReductionPercent.toFixed(1)}%</td><td class="py-3 px-2 text-center border-l">${smoothResult.newEffectiveCpi.toFixed(2)}%</td><td class="py-3 px-2 text-center font-semibold ${smoothCpiDrop > 0.05 ? 'text-orange-600' : 'text-green-600'}">${smoothCpiDrop.toFixed(2)}</td></tr>`;
        }).join('');
        dom.tableFootnote.textContent = '* In the final year, the "Smooth" strategy is not applicable. Its impact is shown as equivalent to the "Recalculate" strategy for comparison.';
        dom.tableFootnote.style.display = 'block';
    }

    function showDetailedAnalysis(index) {
        const result = state.analysisResults[index];
        if (!result || result.error) return;

        const { shockAge, potsBeforeShock, potsAfterShock, potsAfterRebalance } = result;
        dom.modalTitle.textContent = `Detailed Analysis for Shock at Age ${shockAge}`;
        
        const rebalanceTable = ['drawdown', 'annuity', 'excess'].map(potKey => {
            const before = potsAfterShock[potKey];
            const after = potsAfterRebalance[potKey];
            const rebalance = after - before;
            const rebalanceColor = rebalance > 0 ? 'text-green-600' : (rebalance < 0 ? 'text-red-600' : 'text-gray-500');
            return `<tr><td class="py-1 capitalize">${potKey} Pot</td><td class="py-1 text-right">${formatCurrency(before)}</td><td class="py-1 text-right">${formatCurrency(after)}</td><td class="py-1 text-right font-semibold ${rebalanceColor}">${rebalance > 0 ? '+' : ''}${formatCurrency(rebalance)}</td></tr>`;
        }).join('');

        dom.modalContent.innerHTML = `
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Pot Values at Start of Year ${shockAge} (Before Shock)</h4>
                <div class="grid grid-cols-3 gap-4 text-center p-3 bg-gray-50 rounded-lg">
                    <div><span class="text-sm text-gray-500 block">Drawdown</span><span class="font-bold">${formatCurrency(potsBeforeShock.drawdown)}</span></div>
                    <div><span class="text-sm text-gray-500 block">Annuity</span><span class="font-bold">${formatCurrency(potsBeforeShock.annuity)}</span></div>
                    <div><span class="text-sm text-gray-500 block">Excess</span><span class="font-bold">${formatCurrency(potsBeforeShock.excess)}</span></div>
                </div>
            </div>
            <div class="border-t pt-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Pot Rebalancing (End of Year ${shockAge})</h4>
                <p class="text-sm text-gray-600 mb-3">This shows how the pots are rebalanced after the shock to fund the new sustainable income from age ${shockAge + 1}.</p>
                <table class="w-full text-left text-sm">
                    <thead><tr class="border-b"><th class="py-2 font-medium">Pot</th><th class="py-2 font-medium text-right">Value After Shock</th><th class="py-2 font-medium text-right">Value After Rebalance</th><th class="py-2 font-medium text-right">Rebalance Amount</th></tr></thead>
                    <tbody>${rebalanceTable}</tbody>
                </table>
            </div>
        `;

        dom.detailsModal.classList.remove('opacity-0', 'pointer-events-none');
        dom.detailsModal.querySelector('div').classList.remove('scale-95');
    }

    function hideDetailedAnalysis() {
        dom.detailsModal.classList.add('opacity-0', 'pointer-events-none');
        dom.detailsModal.querySelector('div').classList.add('scale-95');
    }

    // --- INITIALIZATION ---
    function initializeApp() {
        createInputField({ key: 'targetStartingIncome', label: 'Target Starting Income', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>', isCurrency: true });
        createInputField({ key: 'startingPot', label: 'Starting Pension Pot', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>', isCurrency: true });
        createInputField({ key: 'startingAge', label: 'Your Starting Age', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'annuityAge', label: "Annuity 'Fix' Age", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'cpi', label: 'Inflation (CPI)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'annuityRate', label: 'Annuity Rate - CPI linked (%)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        createInputField({ key: 'growthFundReturn', label: 'Growth Fund Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'lowRiskFundReturn', label: 'Low-Risk Fund Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' });
        createInputField({ key: 'shockReturn', label: 'Growth Fund Shock Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>', disabled: false });
        createInputField({ key: 'shockLowRiskReturn', label: 'Low-Risk Fund Shock Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' });
        createInputField({ key: 'shockAnnuityRate', label: 'Shock Annuity Rate - CPI linked (%)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        
        createAllocationSlider({ potKey: 'Drawdown', label: 'Pre-annuity Drawdown Pot', startKey: 'drawdownAllocationStart', endKey: 'drawdownAllocationEnd', deRiskKey: 'drawdownDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Annuity', label: 'Annuity Pot', startKey: 'annuityAllocationStart', endKey: 'annuityAllocationEnd', deRiskKey: 'annuityDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Excess', label: 'Excess Pot (Fixed)', endKey: 'excessAllocation' });
        
        // Event Listeners
        dom.modeMaxBtn.addEventListener('click', () => {
            state.mode = 'max';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'none';
        });
        dom.modeTargetBtn.addEventListener('click', () => {
            state.mode = 'target';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'block';
        });
        dom.runAnalysisBtn.addEventListener('click', runBatchAnalysis);
        dom.closeModalBtn.addEventListener('click', hideDetailedAnalysis);
        dom.detailsModal.addEventListener('click', (e) => { if (e.target === dom.detailsModal) { hideDetailedAnalysis(); } });
        
        document.body.addEventListener('mouseover', e => {
            if (e.target.closest('.tooltip-trigger')) {
                const trigger = e.target.closest('.tooltip-trigger');
                const rect = trigger.getBoundingClientRect();
                dom.tooltip.textContent = trigger.dataset.tooltip;
                dom.tooltip.style.left = `${rect.left + rect.width / 2}px`;
                dom.tooltip.style.top = `${rect.bottom + 8}px`;
                dom.tooltip.style.transform = 'translateX(-50%)';
                dom.tooltip.classList.remove('opacity-0');
            }
        });
        document.body.addEventListener('mouseout', e => {
            if (e.target.closest('.tooltip-trigger')) {
                dom.tooltip.classList.add('opacity-0');
            }
        });

        initializeCharts();
        runBatchAnalysis();
    }

    initializeApp();
});
</script>
</body>
</html>
