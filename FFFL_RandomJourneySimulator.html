<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFFL Random Journey Simulator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
            <a href="index.html" class="absolute top-0 left-0 inline-flex items-center text-purple-600 hover:text-purple-800 transition-colors font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Home
            </a>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 tracking-tight pt-10 sm:pt-0">FFFL Random Journey Simulator</h1>
            <p class="mt-2 text-lg text-gray-600">Simulate your retirement journey with volatile market returns.</p>
             <p class="mt-4 max-w-3xl mx-auto text-sm text-gray-500">
                This tool uses the 'Flex First, Fix Later' strategy but introduces market volatility. It calculates an initial sustainable income, then simulates a single retirement journey year-by-year with random investment returns. Each year, the plan is recalibrated based on the actual returns experienced, showing how your income might evolve over time.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg-col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit space-y-6">
                
                <div>
                    <button id="runAnalysisBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>
                        Run New Simulation
                    </button>
                </div>

                <!-- Core Assumptions -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>Core Assumptions</h2>
                    <div class="flex items-center justify-center bg-gray-100 rounded-lg p-1 mb-4">
                        <button id="modeMaxBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow">Max Income</button>
                        <button id="modeTargetBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Target Income</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputTargetStartingIncome" style="display: none;"></div>
                        <div id="inputStartingPot"></div>
                        <div id="inputStartingAge"></div>
                        <div id="inputAnnuityAge"></div>
                        <div id="inputCpi"></div>
                        <div id="inputAnnuityRate"></div>
                    </div>
                </div>
                
                <!-- Recalibration Strategy -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>Annual Recalibration Strategy</h2>
                     <div class="flex items-center justify-center bg-gray-100 rounded-lg p-1">
                        <button id="strategyRecalculateBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow">Recalculate Income</button>
                        <button id="strategySmoothBtn" class="w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600">Smooth Increases</button>
                    </div>
                </div>

                <!-- Fund Returns -->
                <div class="border-t border-gray-200 pt-6">
                     <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M12 2a10 10 0 0 0-4.37 18.02c.24.8.87 1.43 1.69 1.83a2.99 2.99 0 0 0 3.36 0c.82-.4 1.45-1.03 1.69-1.83A10 10 0 0 0 12 2Z"></path><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path><path d="M12 14a2.5 2.5 0 0 0-2.5 2.5v.5a2.5 2.5 0 0 0 5 0v-.5A2.5 2.5 0 0 0 12 14Z"></path></svg>Underlying Fund Returns</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
                        <div id="inputGrowthFundReturn"></div>
                        <div id="inputGrowthFundVolatility"></div>
                        <div id="inputLowRiskFundReturn"></div>
                        <div id="inputLowRiskFundVolatility"></div>
                     </div>
                </div>

                <!-- Investment Strategies -->
                <div class="border-t border-gray-200 pt-6 space-y-4">
                    <h2 class="text-xl font-semibold mb-4 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-purple-600"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>Pot Investment Strategies (% Growth Fund)</h2>
                    <div id="strategyDrawdown"></div>
                    <div id="strategyAnnuity"></div>
                    <div id="strategyExcess"></div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                 <div id="resultsContainer" class="space-y-8">
                    <div id="initialPlanCard" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200"></div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-semibold mb-4 text-gray-800">Simulated Pot Value Journey</h3>
                        <div class="h-[250px]"><canvas id="potChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-semibold mb-4 text-gray-800">Simulated Annual Income</h3>
                        <div class="h-[250px]"><canvas id="incomeChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Simulation Year-by-Year Breakdown</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead id="breakdownThead"></thead>
                                <tbody id="breakdownTbody"></tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal for Detailed Analysis -->
    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 sm:p-8 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modalContent" class="space-y-6"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE MANAGEMENT ---
    let state = {
        mode: 'max',
        targetStartingIncome: 40000,
        recalibrationStrategy: 'recalculate', // 'recalculate' or 'smooth'
        startingPot: 1000000,
        startingAge: 65,
        annuityAge: 80,
        cpi: 3,
        annuityRate: 9.10,
        growthFundReturn: 5,
        growthFundVolatility: 10,
        lowRiskFundReturn: 3.5,
        lowRiskFundVolatility: 0,
        drawdownAllocationStart: 100,
        drawdownAllocationEnd: 100,
        annuityAllocationStart: 100,
        annuityAllocationEnd: 0,
        excessAllocation: 100,
        drawdownDeRiskingPeriod: 15,
        annuityDeRiskingPeriod: 15,
        detailedProjections: [],
        randomReturns: [], // To store the sequence of random returns for a single simulation
    };

    // --- DOM ELEMENT REFERENCES ---
    const dom = {
        runAnalysisBtn: document.getElementById('runAnalysisBtn'),
        modeMaxBtn: document.getElementById('modeMaxBtn'),
        modeTargetBtn: document.getElementById('modeTargetBtn'),
        inputTargetStartingIncome: document.getElementById('inputTargetStartingIncome'),
        strategyRecalculateBtn: document.getElementById('strategyRecalculateBtn'),
        strategySmoothBtn: document.getElementById('strategySmoothBtn'),
        resultsContainer: document.getElementById('resultsContainer'),
        initialPlanCard: document.getElementById('initialPlanCard'),
        breakdownThead: document.getElementById('breakdownThead'),
        breakdownTbody: document.getElementById('breakdownTbody'),
        detailsModal: document.getElementById('detailsModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalContent: document.getElementById('modalContent'),
        closeModalBtn: document.getElementById('closeModalBtn'),
    };

    // --- UI COMPONENT CREATORS ---
    const createInputField = ({ key, label, icon }) => {
        const container = document.getElementById(`input${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (!container) return;
        const unit = key.toLowerCase().includes('pot') || key.toLowerCase().includes('income') ? 'Â£' : '%';
        const step = key.toLowerCase().includes('pot') || key.toLowerCase().includes('income') ? 1000 : 0.1;
        container.innerHTML = `
            <div class="relative">
                <label class="flex items-center text-sm font-medium text-gray-600 mb-1">${icon}<span class="ml-2">${label}</span></label>
                <div class="relative">
                    <input type="text" inputMode="decimal" step="${step}" value="${state[key]}" id="${key}Input" 
                           class="w-full pl-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 pr-10" />
                    <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 text-sm">${unit}</span>
                </div>
            </div>`;
        const inputEl = document.getElementById(`${key}Input`);
        inputEl.addEventListener('blur', () => {
            const parsedValue = parseFloat(inputEl.value);
            if (!isNaN(parsedValue)) { state[key] = parsedValue; } else { inputEl.value = state[key]; }
        });
        inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { inputEl.blur(); } });
    };

    const createAllocationSlider = ({ potKey, label, startKey, endKey, deRiskKey }) => {
        const container = document.getElementById(`strategy${potKey}`);
        if (!container) return;
        const deRiskSliderHtml = deRiskKey ? `
            <div>
                <label class="text-sm font-medium text-gray-500">De-risking Period (Years)</label>
                <div class="flex items-center space-x-4">
                    <input type="range" min="1" max="${state.annuityAge - state.startingAge}" value="${state[deRiskKey]}" id="${deRiskKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" />
                    <div class="font-semibold text-purple-600 w-12 text-right">${state[deRiskKey]} yrs</div>
                </div>
            </div>` : '';
        container.innerHTML = `
            <div class="p-4 border rounded-lg space-y-3 bg-gray-50">
                <label class="flex items-center text-md font-semibold text-gray-700">${label}</label>
                ${startKey ? `<div><label class="text-sm font-medium text-gray-500">Start Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[startKey]}" id="${startKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[startKey]}%</div></div></div>` : ''}
                ${endKey ? `<div><label class="text-sm font-medium text-gray-500">${startKey ? 'End' : ''} Allocation</label><div class="flex items-center space-x-4"><input type="range" min="0" max="100" value="${state[endKey]}" id="${endKey}Slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600" /><div class="font-semibold text-purple-600 w-12 text-right">${state[endKey]}%</div></div></div>` : ''}
                ${deRiskSliderHtml}
            </div>`;
        if (startKey) { document.getElementById(`${startKey}Slider`).addEventListener('input', (e) => { state[startKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[startKey]}%`; }); }
        if (endKey) { document.getElementById(`${endKey}Slider`).addEventListener('input', (e) => { state[endKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[endKey]}%`; }); }
        if (deRiskKey) { document.getElementById(`${deRiskKey}Slider`).addEventListener('input', (e) => { state[deRiskKey] = parseInt(e.target.value, 10); e.target.nextElementSibling.textContent = `${state[deRiskKey]} yrs`; }); }
    };

    // --- CHART SETUP ---
    const potChartCtx = document.getElementById('potChart').getContext('2d');
    const incomeChartCtx = document.getElementById('incomeChart').getContext('2d');
    let potChart, incomeChart;

    function initializeCharts() {
        if (potChart) potChart.destroy();
        if (incomeChart) incomeChart.destroy();
        const onChartClick = (event) => {
            const points = event.chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
            if (points.length) {
                const firstPoint = points[0];
                const index = firstPoint.index;
                showDetailedAnalysis(index);
            }
        };
        const commonOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Age' } } }, plugins: { legend: { display: true, position: 'top' } }, onClick: onChartClick };
        
        potChart = new Chart(potChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { title: { display: true, text: 'Pot Value' }, ticks: { callback: (v) => formatCurrency(v) } } } } });
        incomeChart = new Chart(incomeChartCtx, { type: 'line', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { title: { display: true, text: 'Annual Income' }, ticks: { callback: (v) => formatCurrency(v) } } } } });
    }

    // --- CALCULATION LOGIC ---
    const formatCurrency = (value) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
    const randomNormal = (mean, stdDev) => {
        let u1 = 0, u2 = 0;
        while (u1 === 0) u1 = Math.random();
        while (u2 === 0) u2 = Math.random();
        const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
        return z0 * stdDev + mean;
    };
    const getBlendedRate = (alloc, p_growth, p_lowRisk) => (alloc / 100) * p_growth + (1 - alloc / 100) * p_lowRisk;
    const getInterpolatedAllocation = (startAlloc, endAlloc, currentYearIndex, totalFlexYears, deRiskingPeriod) => {
        const startOfGlidepathYear = totalFlexYears - deRiskingPeriod;
        if (currentYearIndex < startOfGlidepathYear) return startAlloc;
        if (deRiskingPeriod <= 1) return endAlloc;
        const glidepathYearIndex = currentYearIndex - startOfGlidepathYear;
        return startAlloc + (endAlloc - startAlloc) * (glidepathYearIndex / (deRiskingPeriod - 1));
    };

    const solveForMaxIncome = (p_startPot, p_startAge, p_endAge, p_params) => {
        if (p_startAge >= p_endAge) return p_startPot * (p_params.annuityRate / 100);
        let lowIncome = 0, highIncome = p_startPot;
        for (let i = 0; i < 100; i++) {
            const guessIncome = (lowIncome + highIncome) / 2;
            if (guessIncome <= 0) { highIncome = 0; continue; }
            const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(guessIncome, p_startAge, p_endAge, p_params);
            if (annuityPotRequired + drawdownPotRequired < p_startPot) lowIncome = guessIncome; else highIncome = guessIncome;
        }
        return lowIncome;
    };
    
    const solveForEffectiveCpi = (baseIncome, pot, startAge, endAge, params) => {
        let lowCpi = -50, highCpi = 50;
        for(let s=0; s<100; s++) {
            const guessCpi = (lowCpi + highCpi) / 2;
            const tempParams = {...params, cpi: guessCpi};
            const { annuityPotRequired: rAnnuity, drawdownPotRequired: rDrawdown } = calculateRequiredPots(baseIncome, startAge, endAge, tempParams);
            const requiredPot = (rAnnuity + rDrawdown) * (1 + guessCpi / 100);
            if (requiredPot < pot) lowCpi = guessCpi; else highCpi = guessCpi;
        }
        return lowCpi;
    };

    const calculateRequiredPots = (income, p_startAge, p_endAge, p_params) => {
        const { drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, growthFundReturn, lowRiskFundReturn, startingAge, annuityAge, cpi, annuityRate } = p_params;
        const yearsInFlex = p_endAge - p_startAge;
        if (yearsInFlex <= 0) return { annuityPotRequired: 0, drawdownPotRequired: 0 };
        let cumulativeAnnuityDiscount = 1;
        for (let i = 0; i < yearsInFlex; i++) {
            const absoluteYearIndex = (p_startAge - startingAge) + i;
            const allocation = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, absoluteYearIndex, annuityAge - startingAge, annuityDeRiskingPeriod);
            cumulativeAnnuityDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
        }
        const finalIncomeRequired = income * Math.pow(1 + cpi / 100, yearsInFlex);
        const targetAnnuityPotValue = finalIncomeRequired / (annuityRate / 100);
        const annuityPotRequired = targetAnnuityPotValue / cumulativeAnnuityDiscount;
        let drawdownPotRequired = 0;
        for (let j = 0; j < yearsInFlex; j++) {
            let cumulativeDrawdownDiscount = 1;
            for (let k = 0; k < j + 1; k++) {
                const absoluteYearIndex = (p_startAge - startingAge) + k;
                const allocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, absoluteYearIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
                cumulativeDrawdownDiscount *= (1 + getBlendedRate(allocation, growthFundReturn, lowRiskFundReturn) / 100);
            }
            const incomeForYearJ = income * Math.pow(1 + cpi / 100, j);
            const endOfYearAbsoluteIndex = (p_startAge - startingAge) + j;
            const endOfYearAllocation = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, endOfYearAbsoluteIndex, annuityAge - startingAge, drawdownDeRiskingPeriod);
            drawdownPotRequired += incomeForYearJ / (cumulativeDrawdownDiscount / (1 + getBlendedRate(endOfYearAllocation, growthFundReturn, lowRiskFundReturn) / 100));
        }
        return { annuityPotRequired, drawdownPotRequired };
    };
    
    // --- CORE SIMULATION LOGIC ---

    /**
     * Generates a new set of random returns and then processes the simulation.
     * This is called when the user wants a completely new scenario.
     */
    function runNewSimulation() {
        const { startingAge, annuityAge, growthFundReturn, growthFundVolatility, lowRiskFundReturn, lowRiskFundVolatility } = state;
        const yearsInFlex = annuityAge - startingAge;
        state.randomReturns = [];
        for (let i = 0; i < yearsInFlex; i++) {
            state.randomReturns.push({
                growth: randomNormal(growthFundReturn, growthFundVolatility),
                lowRisk: randomNormal(lowRiskFundReturn, lowRiskFundVolatility)
            });
        }
        processSimulation();
    }

    /**
     * Processes the simulation using the currently stored random returns and state settings.
     * This can be called repeatedly to compare strategies on the same set of returns.
     */
    function processSimulation() {
        const params = { ...state };
        const { mode, targetStartingIncome, startingPot, startingAge, annuityAge, drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, excessAllocation, cpi, randomReturns } = params;
        
        const initialIncome = mode === 'target' ? targetStartingIncome : solveForMaxIncome(startingPot, startingAge, annuityAge, params);
        
        const { annuityPotRequired, drawdownPotRequired } = calculateRequiredPots(initialIncome, startingAge, annuityAge, params);
        const requiredTotal = annuityPotRequired + drawdownPotRequired;

        if (mode === 'target' && requiredTotal > startingPot) {
            updateUI({ income: initialIncome, requiredTotal, error: true }, [], []);
            return;
        }

        const initialExcessPot = Math.max(0, startingPot - requiredTotal);
        const initialPlan = {
            income: initialIncome,
            drawdown: drawdownPotRequired,
            annuity: annuityPotRequired,
            excess: initialExcessPot
        };

        const expectedPath = calculateExpectedPath(initialPlan, params);

        // --- Run Stochastic Simulation using stored returns ---
        state.detailedProjections = [];
        let currentAnnuityPot = annuityPotRequired, currentDrawdownPot = drawdownPotRequired, currentExcessPot = initialExcessPot;
        let currentIncome = initialIncome;
        let isOffTrack = false;
        const yearsInFlex = annuityAge - startingAge;

        for (let i = 0; i < yearsInFlex; i++) {
            const currentAge = startingAge + i;
            const potsAtStart = { drawdown: currentDrawdownPot, annuity: currentAnnuityPot, excess: currentExcessPot };
            
            const incomeWithdrawn = currentIncome;
            currentDrawdownPot -= incomeWithdrawn;

            const randGrowthReturn = randomReturns[i].growth;
            const randLowRiskReturn = randomReturns[i].lowRisk;

            const drawdownAlloc = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, i, yearsInFlex, drawdownDeRiskingPeriod);
            const annuityAlloc = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, i, yearsInFlex, annuityDeRiskingPeriod);

            currentDrawdownPot = Math.max(0, currentDrawdownPot * (1 + getBlendedRate(drawdownAlloc, randGrowthReturn, randLowRiskReturn) / 100));
            currentAnnuityPot *= (1 + getBlendedRate(annuityAlloc, randGrowthReturn, randLowRiskReturn) / 100);
            currentExcessPot *= (1 + getBlendedRate(excessAllocation, randGrowthReturn, randLowRiskReturn) / 100);
            
            const potsAfterReturns = { drawdown: currentDrawdownPot, annuity: currentAnnuityPot, excess: currentExcessPot };
            const nextYearTotalPot = currentDrawdownPot + currentAnnuityPot + currentExcessPot;
            
            let nextYearIncome;
            let strategyUsed = "On Track";
            let effectiveCpi = cpi;

            if (mode === 'target' && !isOffTrack) {
                const nextTargetIncome = currentIncome * (1 + cpi / 100);
                const { annuityPotRequired: requiredAnnuity, drawdownPotRequired: requiredDrawdown } = calculateRequiredPots(nextTargetIncome, currentAge + 1, annuityAge, params);
                if (nextYearTotalPot >= (requiredAnnuity + requiredDrawdown)) {
                    nextYearIncome = nextTargetIncome;
                } else {
                    isOffTrack = true;
                    strategyUsed = params.recalibrationStrategy + " (Forced)";
                    if (params.recalibrationStrategy === 'smooth' && currentAge < annuityAge - 1) {
                        effectiveCpi = solveForEffectiveCpi(currentIncome, nextYearTotalPot, currentAge + 1, annuityAge, params);
                        nextYearIncome = currentIncome * (1 + effectiveCpi / 100);
                    } else {
                        nextYearIncome = solveForMaxIncome(nextYearTotalPot, currentAge + 1, annuityAge, params);
                        effectiveCpi = cpi;
                    }
                }
            } else { 
                strategyUsed = params.recalibrationStrategy;
                if (params.recalibrationStrategy === 'smooth' && currentAge < annuityAge - 1) {
                    effectiveCpi = solveForEffectiveCpi(currentIncome, nextYearTotalPot, currentAge + 1, annuityAge, params);
                    nextYearIncome = currentIncome * (1 + effectiveCpi / 100);
                } else {
                    strategyUsed = 'recalculate';
                    nextYearIncome = solveForMaxIncome(nextYearTotalPot, currentAge + 1, annuityAge, params);
                    effectiveCpi = cpi;
                }
            }

            let potsAfterRebalance;
            if (currentAge < annuityAge - 1) {
                const tempParams = { ...params, cpi: effectiveCpi };
                const { annuityPotRequired: nextAnnuity, drawdownPotRequired: nextDrawdown } = calculateRequiredPots(nextYearIncome, currentAge + 1, annuityAge, tempParams);
                potsAfterRebalance = {
                    drawdown: nextDrawdown,
                    annuity: nextAnnuity,
                    excess: nextYearTotalPot - (nextAnnuity + nextDrawdown)
                };
                currentAnnuityPot = nextAnnuity;
                currentDrawdownPot = nextDrawdown;
                currentExcessPot = Math.max(0, potsAfterRebalance.excess);
            } else {
                potsAfterRebalance = { ...potsAfterReturns };
            }
            
            state.detailedProjections.push({
                age: currentAge, income: incomeWithdrawn, totalPot: potsAtStart.drawdown + potsAtStart.annuity + potsAtStart.excess,
                growthReturn: randGrowthReturn, lowRiskReturn: randLowRiskReturn,
                potsAtStart, potsAfterReturns, potsAfterRebalance,
                nextYearIncome, strategyUsed, newEffectiveCpi: effectiveCpi,
                incomeChangePercent: i > 0 ? ((incomeWithdrawn / state.detailedProjections[i-1].income) - 1) * 100 : null
            });
            currentIncome = nextYearIncome;
        }

        const finalAnnuityPotValue = currentAnnuityPot + currentDrawdownPot;
        const finalAnnuityIncome = currentIncome; 

        state.detailedProjections.push({
            age: annuityAge, income: finalAnnuityIncome, totalPot: finalAnnuityPotValue + currentExcessPot,
            growthReturn: null, lowRiskReturn: null,
            potsAtStart: { drawdown: 0, annuity: finalAnnuityPotValue, excess: currentExcessPot },
            incomeChangePercent: (state.detailedProjections.length > 0) ? ((finalAnnuityIncome / state.detailedProjections[yearsInFlex-1].income) - 1) * 100 : null
        });

        updateUI(initialPlan, state.detailedProjections, expectedPath);
    }

    function calculateExpectedPath(initialPlan, params) {
        const { startingAge, annuityAge, drawdownAllocationStart, drawdownAllocationEnd, drawdownDeRiskingPeriod, annuityAllocationStart, annuityAllocationEnd, annuityDeRiskingPeriod, excessAllocation, growthFundReturn, lowRiskFundReturn, cpi } = params;
        const expectedPath = [];
        let expectedDrawdownPot = initialPlan.drawdown;
        let expectedAnnuityPot = initialPlan.annuity;
        let expectedExcessPot = initialPlan.excess;
        let expectedIncome = initialPlan.income;
        const yearsInFlex = annuityAge - startingAge;

        for (let i = 0; i < yearsInFlex; i++) {
            expectedPath.push({ age: startingAge + i, income: expectedIncome, totalPot: expectedDrawdownPot + expectedAnnuityPot + expectedExcessPot });
            expectedDrawdownPot -= expectedIncome;
            const drawdownAlloc = getInterpolatedAllocation(drawdownAllocationStart, drawdownAllocationEnd, i, yearsInFlex, drawdownDeRiskingPeriod);
            const annuityAlloc = getInterpolatedAllocation(annuityAllocationStart, annuityAllocationEnd, i, yearsInFlex, annuityDeRiskingPeriod);
            expectedDrawdownPot *= (1 + getBlendedRate(drawdownAlloc, growthFundReturn, lowRiskFundReturn) / 100);
            expectedAnnuityPot *= (1 + getBlendedRate(annuityAlloc, growthFundReturn, lowRiskFundReturn) / 100);
            expectedExcessPot *= (1 + getBlendedRate(excessAllocation, growthFundReturn, lowRiskFundReturn) / 100);
            expectedIncome *= (1 + cpi / 100);
        }
        expectedPath.push({ age: annuityAge, income: expectedIncome, totalPot: expectedDrawdownPot + expectedAnnuityPot + expectedExcessPot });
        return expectedPath;
    }

    // --- UI UPDATE ---
    function updateUI(initialPlan, projections, expectedPath) {
        const incomeTitle = state.mode === 'target' ? 'Target Starting Income' : 'Max Starting Income';
        let initialPlanContent = `<h3 class="text-xl font-semibold text-gray-800">Initial Plan</h3>`;

        if (initialPlan.error) {
            initialPlanContent += `<div class="bg-red-50 p-4 rounded-lg text-center mt-4"><p class="font-semibold text-red-700">Target Income is Unsustainable</p><p class="text-sm text-red-600 mt-1">Required Pot: ${formatCurrency(initialPlan.requiredTotal)}</p><p class="text-sm text-red-600">Your Pot: ${formatCurrency(state.startingPot)}</p></div>`;
            dom.initialPlanCard.innerHTML = initialPlanContent;
            potChart.data.datasets = []; potChart.update();
            incomeChart.data.datasets = []; incomeChart.update();
            dom.breakdownTbody.innerHTML = '';
            return;
        }

        initialPlanContent += `
            <div class="mt-4 text-center">
                <h4 class="text-sm font-medium text-gray-500">${incomeTitle}</h4>
                <p class="text-3xl font-bold text-purple-600 mt-1">${formatCurrency(initialPlan.income)}</p>
            </div>
            <div class="border-t my-4"></div>
            <h4 class="text-md font-semibold text-gray-700 mb-2 text-center">Initial Pot Allocation</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div><h4 class="text-sm font-medium text-gray-500">Drawdown Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(initialPlan.drawdown)}</p></div>
                <div><h4 class="text-sm font-medium text-gray-500">Annuity Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(initialPlan.annuity)}</p></div>
                <div><h4 class="text-sm font-medium text-gray-500">Excess Pot</h4><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(initialPlan.excess)}</p></div>
            </div>`;
        dom.initialPlanCard.innerHTML = initialPlanContent;
        
        const labels = projections.map(p => p.age);
        potChart.data = { labels, datasets: [ { label: 'Simulated Pot Value', data: projections.map(p => p.totalPot), borderColor: '#8b5cf6', fill: false, tension: 0.1 }, { label: 'Expected Path', data: expectedPath.map(p => p.totalPot), borderColor: '#a78bfa', fill: false, tension: 0.1, borderDash: [5, 5] } ] };
        potChart.update();
        incomeChart.data = { labels, datasets: [ { label: 'Simulated Annual Income', data: projections.map(p => p.income), borderColor: '#2dd4bf', fill: false, tension: 0.1 }, { label: 'Expected Path', data: expectedPath.map(p => p.income), borderColor: '#5eead4', fill: false, tension: 0.1, borderDash: [5, 5] } ] };
        incomeChart.update();

        dom.breakdownThead.innerHTML = `<tr class="border-b-2 border-gray-200"><th class="py-2 px-2 font-semibold">Age</th><th class="py-2 px-2 font-semibold">Income Drawn</th><th class="py-2 px-2 font-semibold">Growth Return</th><th class="py-2 px-2 font-semibold">Start of Year Pot</th><th class="py-2 px-2 font-semibold">Drawdown</th><th class="py-2 px-2 font-semibold">Annuity</th><th class="py-2 px-2 font-semibold">Excess</th></tr>`;
        dom.breakdownTbody.innerHTML = projections.map(row => {
            const growthReturnText = row.growthReturn !== null ? `${row.growthReturn.toFixed(2)}%` : 'N/A';
            const growthColor = row.growthReturn >= state.growthFundReturn ? 'text-green-600' : 'text-red-600';
            const pots = row.potsAtStart;
            let incomeText = formatCurrency(row.income);
            if(row.incomeChangePercent !== null && !isNaN(row.incomeChangePercent)) {
                const percent = row.incomeChangePercent;
                const color = percent >= 0 ? 'text-green-600' : 'text-red-600';
                incomeText += ` <span class="text-xs ${color}">(${percent >= 0 ? '+' : ''}${percent.toFixed(1)}%)</span>`;
            }

            return `<tr class="border-b border-gray-100">
                <td class="py-2 px-2 font-medium">${row.age}</td>
                <td class="py-2 px-2">${incomeText}</td>
                <td class="py-2 px-2 font-semibold ${growthColor}">${growthReturnText}</td>
                <td class="py-2 px-2 font-bold">${formatCurrency(row.totalPot)}</td>
                <td class="py-2 px-2">${formatCurrency(pots.drawdown)}</td>
                <td class="py-2 px-2">${formatCurrency(pots.annuity)}</td>
                <td class="py-2 px-2">${formatCurrency(pots.excess)}</td>
            </tr>`;
        }).join('');
    }

    function showDetailedAnalysis(index) {
        const result = state.detailedProjections[index];
        if (!result || !result.potsAtStart || result.age === state.annuityAge) return;

        dom.modalTitle.textContent = `Detailed Analysis for Age ${result.age}`;
        
        const rebalanceTable = ['drawdown', 'annuity', 'excess'].map(potKey => {
            const before = result.potsAfterReturns[potKey];
            const after = result.potsAfterRebalance[potKey];
            const rebalance = after - before;
            const rebalanceColor = rebalance > 0 ? 'text-green-600' : (rebalance < 0 ? 'text-red-600' : 'text-gray-500');
            return `<tr><td class="py-1 capitalize">${potKey} Pot</td><td class="py-1 text-right">${formatCurrency(before)}</td><td class="py-1 text-right">${formatCurrency(after)}</td><td class="py-1 text-right font-semibold ${rebalanceColor}">${rebalance > 0 ? '+' : ''}${formatCurrency(rebalance)}</td></tr>`;
        }).join('');
        
        let strategyHtml = '';
        if (result.strategyUsed === 'On Track') {
             strategyHtml = `<p class="text-center text-sm">Status: <span class="font-semibold text-green-600">On Track</span></p><p class="text-center text-sm">Target income maintained by using the excess pot as a buffer.</p><p class="text-center text-sm">Income for Age ${result.age + 1}: <span class="font-semibold">${formatCurrency(result.nextYearIncome)}</span></p>`;
        } else if (result.strategyUsed.includes('smooth')) {
            strategyHtml = `<p class="text-center text-sm">Status: <span class="font-semibold text-orange-600">Recalibration</span></p><p class="text-center text-sm">Strategy: <span class="font-semibold text-teal-600">Smooth Increases</span></p><p class="text-center text-sm">Calculated Sustainable Increase Rate: <span class="font-semibold">${result.newEffectiveCpi.toFixed(2)}%</span></p><p class="text-center text-sm">New Income for Age ${result.age + 1}: <span class="font-semibold">${formatCurrency(result.nextYearIncome)}</span></p>`;
        } else {
             strategyHtml = `<p class="text-center text-sm">Status: <span class="font-semibold text-orange-600">Recalibration</span></p><p class="text-center text-sm">Strategy: <span class="font-semibold text-purple-600">Recalculate Income</span></p><p class="text-center text-sm">New Sustainable Income for Age ${result.age + 1}: <span class="font-semibold">${formatCurrency(result.nextYearIncome)}</span></p>`;
        }

        dom.modalContent.innerHTML = `
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Start of Year ${result.age}</h4>
                <div class="grid grid-cols-3 gap-4 text-center p-3 bg-gray-50 rounded-lg">
                    <div><span class="text-sm text-gray-500 block">Drawdown</span><span class="font-bold">${formatCurrency(result.potsAtStart.drawdown)}</span></div>
                    <div><span class="text-sm text-gray-500 block">Annuity</span><span class="font-bold">${formatCurrency(result.potsAtStart.annuity)}</span></div>
                    <div><span class="text-sm text-gray-500 block">Excess</span><span class="font-bold">${formatCurrency(result.potsAtStart.excess)}</span></div>
                </div>
                <p class="text-center mt-2 text-sm">Income Withdrawn: <span class="font-semibold">${formatCurrency(result.income)}</span></p>
            </div>
            <div class="border-t pt-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Investment Returns During Year ${result.age}</h4>
                 <div class="grid grid-cols-2 gap-4 text-center p-3 bg-gray-50 rounded-lg">
                    <div><span class="text-sm text-gray-500 block">Growth Fund Return</span><span class="font-bold ${result.growthReturn >= state.growthFundReturn ? 'text-green-600' : 'text-red-600'}">${result.growthReturn.toFixed(2)}%</span></div>
                    <div><span class="text-sm text-gray-500 block">Low-Risk Fund Return</span><span class="font-bold ${result.lowRiskReturn >= state.lowRiskFundReturn ? 'text-green-600' : 'text-red-600'}">${result.lowRiskReturn.toFixed(2)}%</span></div>
                </div>
            </div>
            <div class="border-t pt-4">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">End of Year ${result.age} Rebalance</h4>
                ${strategyHtml}
                <table class="w-full text-left text-sm mt-3">
                    <thead><tr class="border-b"><th class="py-2 font-medium">Pot</th><th class="py-2 font-medium text-right">Value After Returns</th><th class="py-2 font-medium text-right">Value After Rebalance</th><th class="py-2 font-medium text-right">Rebalance Amount</th></tr></thead>
                    <tbody>${rebalanceTable}</tbody>
                </table>
            </div>
        `;

        dom.detailsModal.classList.remove('opacity-0', 'pointer-events-none');
        dom.detailsModal.querySelector('div').classList.remove('scale-95');
    }

    function hideDetailedAnalysis() {
        dom.detailsModal.classList.add('opacity-0', 'pointer-events-none');
        dom.detailsModal.querySelector('div').classList.add('scale-95');
    }

    // --- INITIALIZATION ---
    function initializeApp() {
        createInputField({ key: 'startingPot', label: 'Starting Pension Pot', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>' });
        createInputField({ key: 'startingAge', label: 'Your Starting Age', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'annuityAge', label: "Annuity 'Fix' Age", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>' });
        createInputField({ key: 'cpi', label: 'Inflation (CPI)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'annuityRate', label: 'Annuity Rate - CPI linked (%)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        createInputField({ key: 'growthFundReturn', label: 'Avg. Growth Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>' });
        createInputField({ key: 'growthFundVolatility', label: 'Growth Volatility (Std. Dev.)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>' });
        createInputField({ key: 'lowRiskFundReturn', label: 'Avg. Low-Risk Return', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>' });
        createInputField({ key: 'lowRiskFundVolatility', label: 'Low-Risk Volatility (Std. Dev.)', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>' });
        createInputField({ key: 'targetStartingIncome', label: 'Target Starting Income', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>' });
        
        createAllocationSlider({ potKey: 'Drawdown', label: 'Pre-annuity Drawdown Pot', startKey: 'drawdownAllocationStart', endKey: 'drawdownAllocationEnd', deRiskKey: 'drawdownDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Annuity', label: 'Annuity Pot', startKey: 'annuityAllocationStart', endKey: 'annuityAllocationEnd', deRiskKey: 'annuityDeRiskingPeriod' });
        createAllocationSlider({ potKey: 'Excess', label: 'Excess Pot (Fixed)', endKey: 'excessAllocation' });
        
        // Event Listeners
        dom.modeMaxBtn.addEventListener('click', () => {
            state.mode = 'max';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'none';
        });
        dom.modeTargetBtn.addEventListener('click', () => {
            state.mode = 'target';
            dom.modeTargetBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.modeMaxBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            dom.inputTargetStartingIncome.style.display = 'block';
        });

        dom.strategyRecalculateBtn.addEventListener('click', () => {
            state.recalibrationStrategy = 'recalculate';
            dom.strategyRecalculateBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.strategySmoothBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            if (state.randomReturns.length > 0) processSimulation();
        });
        dom.strategySmoothBtn.addEventListener('click', () => {
            state.recalibrationStrategy = 'smooth';
            dom.strategySmoothBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors bg-purple-600 text-white shadow';
            dom.strategyRecalculateBtn.className = 'w-1/2 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600';
            if (state.randomReturns.length > 0) processSimulation();
        });

        dom.runAnalysisBtn.addEventListener('click', runNewSimulation);
        dom.closeModalBtn.addEventListener('click', hideDetailedAnalysis);
        dom.detailsModal.addEventListener('click', (e) => { if (e.target === dom.detailsModal) { hideDetailedAnalysis(); } });
        
        initializeCharts();
        runNewSimulation();
    }

    initializeApp();
});
</script>
</body>
</html>
